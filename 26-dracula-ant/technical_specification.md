# Implementation of a work package service for CLI client authentication (Dracula Ant)

**Epic Type:** Implementation Epic
  
**Attention: Please do not put any confidential content here.**

## Scope:

We want to implement the work package service outlined in
https://docs.ghga-dev.de/main/architecture_concepts/ac001_file_validation_and_encryption.html#client-configuration-and-authorization

## Implementation Details:

### REST API

The Work Package Service REST API should have the following end points:

Used by the web frontend to create work packages:

- `POST /work-packages`
  - auth header: internal access token
  - request body:
    - `dataset_id`: str (the ID of a dataset)
    - `type`: enum (download/upload)
    - `file_ids`: array of strings  (empty = all files of the dataset)
    - `public_key`: string (the user's public Crypt4GH key)
  - response body:
    - `id`: str (the work package ID)
    - `token`: str (encrypted work package access token)

Used by the CLI client to retrieve work packages and create work order tokens:

- `GET /work-packages/{work_package_id}`
  - auth header: work package access token
  - gets the specified work package
- `POST /work-packages/{work_package_id}/file/{file_id}/work-order-tokens`
  - auth header: work package access token
  - gets an encrypted work order token for the specified work package and file

The following endpoints could be added later to manage work packages in the web frontend,
but for now, this will *not* be implemented and they are not part of the API.

- `GET /work-packages`
  - auth header: internal access token
  - gets all list of all work packages of the current user
- `GET /work-packages/{work_package_id}`
  - auth header: internal access token
  - gets work package with given id if it belongs to the current user
- `DELETE /work-packages/{work_package_id}`
  - auth header: internal access token
  - deletes work package with given id if it belongs to the current user


### Work package access token

The work package access token is a random string generated by the Work Package Service on a POST request. Its SHA256 hash is stored in the database. The token itself is not stored, but it is encrypted with the `public_key` and then returned in the response.

The frontend should display the work package ID together with the encrypted work package access token separated by a colon as a single string that can be copied and pasted to the CLI client, so that the CLI client gets both pieces of information.

### Work order token

This is a JWT with a very short time to live (maximum 30 seconds). It is signed by the Work Package Service and then encrypted with the `public_key` of the user, similar to the work package access token. It contains the following claims:

- `type`: `download` or `upload`
- `file_id`: the ID of the file that shall be downloaded or uploaded
- `user_id`: the internal ID of the user
- `public_key`: the public key stored in the work package
- `full_user_name`: the full name of the user (with academic title)
- `email`: the email address of the user

The user name and email are part of the token so that the upload/download controllers can log this information and notify the users.

The work order tokens are signed by the Work Package Service. A separate key pair (different from the keys used for the internal access tokens) should be created for this purpose. The public key must be also communicated to the download/upload controller services so that they can validate the work order token.

### Dataset access checks

In order to check whether a given user has *download* access to a given dataset, the claims repository provides the following *internal* endpoint:

- `GET /datasets/{dataset_id}/users/{user_id}/download-access`
  - authorization: only internal from download controller (via Istio)
  - returns `true` or `false` as a scalar resource

In order to facilitate authorization, the path of this endpoint starts with `datasets` and not with `users` which is already used by other endpoints fo the claims repository.

This endpoint will be consulted by the Work Package Service as well as the download service controller.

This information will later be provided by the visa issuer service and checked with the help of the visa library.

In order to check whether a given user has *upload* access to a given dataset, ... TODO


### Data schema

The database of the Work Package Service should store the following WorkPackage objects:

```python
WorkPackage:
  id: str  # the ID of this work package
  user_id: str  # the internal user ID
  dataset_id: str  # all files must belong to the dataset with this ID
  type: enum  # the work order type, either download or upload
  file_ids: list[str]  # a list of IDs for all files that shall be downloaded or uploaded
  public_key: str  # the user's public Crypt4GH key
  full_user_name: str  # the full name of the user (with academic title)
  email: str  # he email address of the user
  token_hash: str  # hash of the work package access token
  created: datetime  # creation date of this work package
  expires: datetime  # expiry date of this work package
```

The database must also keep track of which file IDs belong to which dataset in an association collection indexed by `dataset_id`s:

```python
DatasetFiles:
  dataset_id: str
  file_ids: list[str]
```

To populate this collection, the Work Package Service listens to events from the file submission service. TODO

If an empty `file_ids` array is submitted in the POST request, then the Work Package Service populates it with the complete list taken from this collection.

## Human Resource/Time Estimation:

Number of sprints required: 2

Number of developers required: 1
