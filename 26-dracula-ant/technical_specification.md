# Implementation of a work package service for CLI client authentication (Dracula Ant)

**Epic Type:** Implementation Epic
  
**Attention: Please do not put any confidential content here.**

## Scope:

We want to implement the work package service outlined in
https://docs.ghga-dev.de/main/architecture_concepts/ac001_file_validation_and_encryption.html#client-configuration-and-authorization

## Implementation Details:

### REST API

The Work Package Service REST API should have the following end points:

- `POST /work-packages`
  - auth header: internal access token
  - request body:
    - `dataset_id`: str
    - `type`: enum (download/upload)
    - `file_ids`: array of strings  (empty = all files of the dataset)
    - `public_key`: string (the user's public Crypt4GH key)
  - response body:
    - `id`: the work package id
    - `token`: work package access token
- `GET /work-packages`
  - auth header: internal access token
  - gets all list of all work packages of the current user
- `GET /work-packages/{id}`
  - auth header: internal access token
  - gets work package with given id if it belongs to the current user
- `DELETE /work-packages/{id}`
  - auth header: internal access token
  - deletes work package with given id if it belongs to the current user
- `GET /work-package`
  - auth header: work package access token
  - gets work package that has the same hash as the given token
    (note that this is not really RESTful, the work package is passed in directly via the token)
- `GET /work-order-token`
  - auth header: work package access token
  - query path parameter: `file_id`
  - gets an encrypted work order token for the given work package access token

### Work package access token

The work package access token is a random string generated by the Work Package Service on a POST request. Its SHA256 hash is stored in the database. The token itself is not stored, but it is encrypted with the `public_key` and then returned in the response.

### Work order token

This is a JWT with a very short time to live (maximum 30 seconds). It is signed by the Work Package Service and then encrypted with the `public_key` of the user, similar to the work package access token. It contains the following claims:

- `type`: `download` or `upload`
- `file_id`: the id of the file that shall be downloaded or uploaded
- `user_id`: the internal ID of the user
- `public_key`: the public key stored in the work package

The work order tokens are signed by the Work Package Service. A separate key pair (different from the keys used for the internal access tokens) should be created for this purpose. The public key must be also communicated to the download/upload controller services so that they can validate the work order token.

### Dataset access checks

In order to check whether a given user has access to a given dataset, the claims repository provides an *internal* RPC endpoint that would return `false` or `true` according to whether the user has access or not.
- `/rpc/has_access?dataset_id=...&user_id=...`

This endpoint will be consulted by the Work Package Service as well as the download/upload services controllers.

Access permissions may later be stored in an internal database populated by evens sent by a data access service.

### Data schema

The database of the Work Package Service should store the following WorkPackage objects:

```python
WorkPackage:
  id: str
  user_id: str  # the internal used id
  dataset_id: str  # all files must belong to this dataset
  type: enum  # download or upload
  file_ids: list[str]  # a list of ids for all files that shall be downloaded or uploaded
  public_key: str  # the user's public Crypt4GH key
  token_hash: str  # hash of the work package access token
  created: datetime
  expires: datetime
```

The database must also keep track of which file IDs belong to which dataset in an association collection indexed by dataset_ids:

```python
DatasetFiles:
  dataset_id: str
  file_ids: list[str]
```

To populate this collection, the Work Package Service listens to events from the file submission service. (to be clarified)

If an empty `file_ids` array is submitted in the POST request, then the Work Package Service populates it with the complete list taken from this collection.

## Human Resource/Time Estimation:

Number of sprints required: 2

Number of developers required: 1
