# Implementation of a work package service for CLI client authentication (Dracula Ant)

**Epic Type:** Implementation Epic
  
**Attention: Please do not put any confidential content here.**

## Scope:

We want to implement the work package service outlined in
https://docs.ghga-dev.de/main/architecture_concepts/ac001_file_validation_and_encryption.html#client-configuration-and-authorization

## Implementation Details:

### REST API

The Work Package Service REST API should have the following end points:

Used by the web frontend to create work packages:

- `POST /work-packages`
  - auth header: internal access token
  - request body:
    - `dataset_id`: str (the ID of a dataset)
    - `type`: enum (download/upload)
    - `file_ids`: array of strings  (empty = all files of the dataset)
    - `public_key`: string (the user's public Crypt4GH key)
  - response body:
    - `id`: str (the work package ID)
    - `token`: str (encrypted work package access token)

Used by the CLI client to retrieve work packages and create work order tokens:

- `GET /work-packages/{work_package_id}`
  - auth header: work package access token
  - gets the specified work package
- `POST /work-packages/{work_package_id}/file/{file_id}/work-order-tokens`
  - auth header: work package access token
  - gets an encrypted work order token for the specified work package and file

The following endpoints could be added later to manage work packages in the web frontend, but for now, this will *not* be implemented and they are *not* part of the API.

- `GET /work-packages`
  - auth header: internal access token
  - gets all list of all work packages of the current user
- `GET /work-packages/{work_package_id}`
  - auth header: internal access token
  - gets work package with given id if it belongs to the current user
- `DELETE /work-packages/{work_package_id}`
  - auth header: internal access token
  - deletes work package with given id if it belongs to the current user

Deletion of work packages should be logged or implemented as deactivation (immediate expiration) so that the fact that a work package access token had been created by a user is archived in the system.

### Work package access token

The work package access token is a random string generated by the Work Package Service on a POST request. Its SHA256 hash is stored in the database. The token itself is not stored, but it is encrypted with the `public_key` and then returned in the response.

The frontend should display the work package ID together with the encrypted work package access token separated by a colon as a single string that can be copied and pasted to the CLI client, so that the CLI client gets both pieces of information.

### Work order token

This is a JWT with a very short time to live (maximum 30 seconds). It is signed by the Work Package Service and then encrypted with the `public_key` of the user, similar to the work package access token. It contains the following claims:

- `type`: `download` or `upload`
- `file_id`: the ID of the file that shall be downloaded or uploaded
- `user_id`: the internal ID of the user
- `public_key`: the public key stored in the work package
- `full_user_name`: the full name of the user (with academic title)
- `email`: the email address of the user

The user name and email are part of the token so that the upload/download controllers can log this information and notify the users.

The work order tokens are signed by the Work Package Service. A separate key pair (different from the keys used for the internal access tokens) should be created for this purpose. The public key must be also communicated to the download/upload controller services so that they can validate the work order token.

### Dataset access checks

#### Access checks by the Work Package Service

To allow the Work Package Service to check whether a given user has *download* access to a given dataset, the claims repository provides the following *internal* endpoint:

- `GET /datasets/{dataset_id}/users/{user_id}/download-access`
  - authorization: only internal from download controller (via Istio)
  - returns `true` or `false` as a scalar resource

In order to facilitate authorization, the path of this endpoint starts with `datasets` and not with `users` which is already used by other endpoints fo the claims repository.

This information will later be provided by the visa issuer service and checked with the help of the visa library.

In order to check whether a given user has *upload* access to a given dataset, we may introduce a similar endpoint that will be based on checking custom visa types for dataset submission in the claims repository. Alternatively, we could store a list of internal user IDs of dataset submitters also in the `DatasetFiles` collection described below and update them similarly to the file IDs belonging to the dataset. (To be clarified, will be implemented later.)

#### Access checks by the Download/Upload Controllers

The download and upload service controllers authorize access to files by validating the content and signature of the passed work order token. The work order tokens are only valid for a very short time and for a specific file.

### Data schema

The database of the Work Package Service should store the following WorkPackage objects:

```python
WorkPackage:
  id: str  # the ID of this work package
  user_id: str  # the internal user ID
  dataset_id: str  # all files must belong to the dataset with this ID
  type: enum  # the work order type, either download or upload
  file_ids: list[str]  # a list of IDs for all files that shall be downloaded or uploaded
  public_key: str  # the user's public Crypt4GH key
  full_user_name: str  # the full name of the user (with academic title)
  email: str  # he email address of the user
  token_hash: str  # hash of the work package access token
  created: datetime  # creation date of this work package
  expires: datetime  # expiry date of this work package
```

The `file_ids` list must not be empty. It contains either the `file_ids` specified by the user when creating the work package (in this case the Work Package Service checks whether they belong to the given `dataset_id`), or the full list of all `file_id`s that belong to the given `dataset_id`.

An entry in the `WorkPackage` collection is only created by the Work Package Service after verification that the user with the given `user_id` is allowed to access the dataset with the given `dataset_id` (see access checks above).

In the database, the Work Package Service also keeps track of which file IDs belong to which dataset and which users are allowed to submit data for the individual datasets. The following association collection is used for this purpose:

```python
DatasetFiles:
  dataset_id: str  # (should have a unique index)
  file_ids: list[str]  # all file IDs that are part of the dataset
```

To populate this collections, the Work Package Service listens to events published by another service. (To be clarified.)

## Human Resource/Time Estimation:

Number of sprints required: 2

Number of developers required: 1
