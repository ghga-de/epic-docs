openapi: 3.0.3

info:
  title: Upload Controller Service
  version: 0.2.0

paths:
  /files/{file_id}:
    get:
      operationId: getFileMetadata
      description: Get file metadata including the current upload attempt.
      parameters:
        - name: file_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: File metadata including the current upload attempt
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/FileMetadata"
        "403":
          description: |
            Exceptions by ID:
              - userNotRegisteredFileAccess: The user is not registered
                as a Data Submitter for the corresponding file.
        "404":
          description: |
            Exceptions by ID:
             - fileNotRegisteredAccess: The file with the given ID has
               not (yet) been registered for upload.

  /uploads:
    post:
      operationId: createUpload
      description: Initiate a new multi-part upload.
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UploadCreation"
      responses:
        "200":
          description: Details on the newly created upload.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UploadDetails"
        "400":
          description: |
            Exceptions by ID:
              - uploadAttemptPresentPending: Imposible to create a new upload for
                the file with the specific ID. Another upload in pending status
                already exists for this file.
              - uploadAttemptPresentUploaded: Imposible to create a new upload for
                the file with the specific ID. Another upload in uploaded status
                already exists for this file.
              - uploadAttemptPresentAccepted: Imposible to create a new upload for
                the file with the specific ID. Another upload in accepted status
                already exists for this file.
        "403":
          description: |
            Exceptions by ID:
              - noFileAccess: The user is not registered
                as a Data Submitter for the corresponding file.

  /uploads/{upload_id}:
    get:
      operationId: getUploadDetails
      description: Get details on a specific upload.
      parameters:
        - name: upload_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Details on a specific upload.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UploadDetails"
        "403":
          description: |
            Exceptions by ID:
              - noFileAccess: The user is not registered
                as a Data Submitter for the file corresponding to this upload.
        "404":
          description: |
            Exceptions by ID:
              - NoSuchUpload: The multi-part upload with the given ID
                does not exist.

    patch:
      operationId: updateUploadStatus
      description: |
        Declare a multi-part upload as complete by setting its status to "uploaded".
        Or cancel a multi-part upload by setting its status to "cancelled".
      parameters:
        - name: upload_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UploadUpdate"
      responses:
        "204":
          description: Multi-part upload successfully updated.
        "400":
          description: |
            Exceptions by ID:
              - pendingInvalidChange: Cannot change status from pending to accepted or rejected
              - uploadedInvalidChange: Cannot change status from uploaded to cancelled or pending
              - invalidChangeFromCancelled: Cannot change status from cancelled for this upload attempt.
                If you want to restart, initiate a new multi-part upload instead.
              - invalidChangeFromFailed: Cannot change status from failed for this upload attempt.
                If you want to restart, initiate a new multi-part upload instead.
              - invalidChangeFromAccepted: Upload has already been accepted, a status change or
                new upload attempt is no longer possible.
              - invalidChangeFromRejected: Cannot change status from rejected for this upload attempt.
                If you want to restart, initiate a new multi-part upload instead.
        "403":
          description: |
            Exceptions by ID:
              - noFileAccess: The user is not registered
                Data Submitter for the file corresponding to this multi-part upload.
        "404":
          description: |
            Exceptions by ID:
              - noSuchUpload: The multi-part upload with the given ID
                does not exist.

  /uploads/{upload_id}/parts/{part_no}/signed_urls:
    post:
      operationId: createPreSignedURL
      description: |
        Create a pre-signed URL for the specified part number of the specified multi-part
        upload.
      parameters:
        - name: upload_id
          in: path
          required: true
          schema:
            type: string
        - name: part_no
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
            maximum: 10000
      responses:
        "200":
          description: |
            The newly created pre-signed url.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AccessURL"
        "403":
          description: |
            Exceptions by ID:
              - userNotRegisteredPresignPart: The user is not registered as a
                Data Submitter for the file corresponding to this multi-part upload.
        "404":
          description: |
            Exceptions by ID:
              - noSuchUpload: The multi-part upload with the given ID
                does not exist.

components:
  schemas:
    KnownException:
      type: object
      properties:
        description:
          type: string
          description: A message to the client describing what went wrong.
        exceptionId:
          type: string
          description: A string toidentify the domain logic problem.
        data:
          type: object
          description: Additional machine-readable information on the exception.
      required:
        - description
        - exceptionId
        - data

    AccessURL:
      type: object
      required:
        - url
      properties:
        url:
          type: string
          description: |
            A fully resolvable URL that can be used to upload the actual object
            bytes for one upload part.

    UploadCreation:
      title: Properties required to create a new upload
      type: object
      properties:
        file_id:
          type: string
          description: The ID of the file corresponding to this upload.
      required:
        - file_id

    UploadDetails:
      title: Multi-Part Upload Details
      type: object
      properties:
        upload_id:
          type: string
        file_id:
          type: string
          description: The ID of the file corresponding to this upload.
        part_size:
          type: integer
          description: Part size in bytes.
      required:
        - upload_id
        - file_id
        - part_size

    UploadUpdate:
      title: Multi-Part Upload Update
      type: object
      properties:
        upload_status:
          type: string
          enum:
            - uploaded
            - cancelled

    FileMetadata:
      title: Multi-Part Upload Details
      type: object
      properties:
        file_id:
          type: string
        file_name:
          type: string
        md5_checksum:
          type: string
        size:
          type: integer
          minimum: 0
        grouping_label:
          type: string
        creation_date:
          type: string
          format: date-time
        update_date:
          type: string
          format: date-time
        format:
          type: string
        current_upload_id:
          description: |
            ID of the current upload. `Null` if no update has been
            initiated, yet.
          type: string
          nullable: true
      required:
        - file_id
        - file_name
        - size
        - md5_checksum
        - grouping_label
        - creation_date
        - update_date
        - format
        - current_upload_id
